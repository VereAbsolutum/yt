<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <header class="header " >
        <nav class="navbar bg-body-tertiary ">
            <div class="container-fluid ">
                <div class="border border-sm w-100">
                    <h2 class="my-4">
                        Manwha
                    </h2>
                </div>
            </div>
          </nav>
    </header>
    <main>
        <section class="mb-4">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header">
                        <h1 class="text-center">Importar</h1>
                    </div>
                    <div class="card-body">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <header class="pt-4">
                                                <h2 class="">Imagens</h2>
                                            </header>
                                            <hr>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="formFileMultiple" class="form-label">Escolha as imagens.</label>
                                                <input id="image-input" class="form-control" type="file" id="formFileMultiple" multiple>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="formFileMultiple" class="form-label">Escolha os textos.</label>
                                                <input disabled id="text-input" class="form-control" type="file" id="formFileMultiple" multiple>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                                <button id="listar" type="button" class="btn btn-warning btn-block py-4 rounded-0">Listar</button>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="mb-4">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header ">
                        <h2 class="text-center">
                            Imagens Grid
                        </h2>
                    </div>
                    <div class="card-body pt-4">
                        <h3 class="text-center mb-4">Escolhas as imagens abaixo</h3>
                        <hr>
                            <div class="container">
                                <div class="row">
                                    <div class="col-md-4"></div>
                                    <div class="col-md-4">
                                        <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                            <button  id="clean-all-selections" type="button" class="btn btn-danger btn-block py-4 rounded-0">Limpar</button>
                                            <button id="save-all" type="button" class="btn btn-primary btn-block py-4 rounded-0">Salvar</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                    </div>
                                </div>
                            </div>
                        <hr>
                        <div class="container-fluid mt-4">
                            <div id="grid" class="row">
                                <!--

                                <div class="col-md-4">
                                    <div class="d-flex justify-content-center align-items-end h-100">

                                        <div id="card-0" class="card mb-3" style="max-width: 540px;">
                                            <div class="row g-0">
                                                <div class="col-md-6">
                                                    <div id="previewInputGroup" class="input-group mb-3">
                                                        <input type="file" class="form-control visually-hidden" id="inputGroupFile01" aria-describedby="inputGroupFileAddon01">
                                                        <label class="input-group-text p-0" for="inputGroupFile01">
                                                            <img data-imageSrc src="./project/Damn-Reincarnation/img/1.1/0099-3-image.png" class="img-fluid rounded-start input-image" alt="...">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card border border-0 h-100">
                                                        <div class="card-header p-0">
                                                            <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                                                <button type="button" class="btn btn-danger btn-block py-1 rounded-0">Excluir</button>
                                                                <button type="button" class="btn btn-alert btn-primary py-1 rounded-0">Salvar</button>
                                                                <button type="button" class="btn btn-success btn-block py-1 rounded-0">+</button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                        <h5 class="card-title">Card title</h5>
                                                        <p data-text class="card-text input-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                                                        <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p>
                                                        </div>
                                                        <div class="card-footer p-0">
                                                            <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                                                <button type="button" class="btn btn-primary btn-block py-4 rounded-0">Incluir</button>
                                                                <button type="button" class="btn btn-danger btn-block py-4 rounded-0">Excluir</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="position-fixed bottom-0 end-0 " style="margin-right: 2rem; margin-bottom: 2rem;">
            <button id="total"  type="button" class="btn btn-primary">0</button>
        </div>
    </main>
    <!-- Inclua a biblioteca JSZip via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="./asset/js/view_components/card.js"></script>
    <script>
        function loadInputFiles(files, type='image') {
            var promisses = [];

            [...files].forEach(file => {
                promisses.push(new Promise((resolve, reject) => {
                    var reader = new FileReader();

                    reader.onload = function(e) {
                        var content = e.target.result;
                        resolve(content);
                    }

                    reader.onerror = function(err) {
                        reject(err);
                    }

                    if (type == 'text'){
                        reader.readAsText(file);
                    } else if(type=='image'){
                        reader.readAsDataURL(file);
                    }
                }));
            });

            return Promise.all(promisses);
        }
    </script>

    <script>
        function TemporaryStorage() {
            var data = [];
            var text =  '';

            var textConcat = function () {
                data.forEach(entry => {
                    text += entry.text + '.';
                })
            }

            var setText = function (newText) {
                text = newText;
            }

            var getText = function () {
                return text
            }

            var add = function(item) {
                data.push(item);
                loadCards(data);
                __updateTextsElements(data.length - 1, 'add', item.text);
            };

            var remove = function(index) {
                data.splice(index, 1);
                console.log('r', index, data);
                loadCards(data);
                __updateTextsElements(index, 'remove');
            };

            var duplicate = function(index) {
                var newCard = { ...data[index] };
                data.splice(index + 1, 0, newCard);
                console.log('duplicate',newCard, index, data);
                loadCards(data);
                __updateTextsElements(index + 1, 'duplicate', newCard.text);
            }

            var __updateTextsElements=function(index, type, sentence = null) {
                var textElement = document.querySelectorAll('.manwha-card [data-text]')[index];

                switch (type) {
                    case 'remove':
                        var newTextArray = text.split('.');
                        newTextArray.splice(index, 1);
                        text = newTextArray.join('.');
                        break;
                    case 'add':
                        var newTextArray = text.split('.');
                        newTextArray.splice(index, 0, sentence);
                        text = newTextArray.join('.');
                        break;
                    case 'duplicate':
                        var newTextArray = text.split('.');
                        newTextArray.splice(index, 0, sentence);
                        text = newTextArray.join('.');
                        break;
                    default:
                        updateText(textElement);
                }
            }

            var getData = function() {
                return data;
            };

            return {
                add: add,
                remove: remove,
                getData: getData,
                duplicate: duplicate,
                setText: setText,
                textConcat: textConcat,
                getText:getText
            };
        }

        var storage = new TemporaryStorage();
    </script>

    <script>
        var cardTemplate = {
            title: '',
            text: '',
            image: ''
        };
    </script>

    <script>
        function newCard ({imageUrl, title, text=null}) {
            var card = Object.assign({}, cardTemplate);
            card.title = title;
            card.text = text;
            card.image = imageUrl;
            return card;
        }
    </script>

    <script>
        function loadCards(cardsData) {
            var grid = document.getElementById('grid');

            grid.innerHTML = '';
            var fragment = document.createDocumentFragment();

            cardsData.forEach((data, index) => {
                var card = createCard({
                    text: data.text,
                    image: data.image,
                    id: index
                });

                //var deleteButton = card.querySelector('.card-delete');
                //var duplicateButton = card.querySelector('.card-duplicate');
                //var saveButton = card.querySelector('.card-save');

                //deleteButton.addEventListener('click', () => storage.remove(index));
                //duplicateButton.addEventListener('click', () => storage.duplicate(index));
                //saveButton.addEventListener('click', () => saveCard(index));

                fragment.appendChild(card);
            })

            grid.appendChild(fragment);
        }
    </script>

    <script>
        function getData (ev) {
            var imageInput = document.getElementById("image-input");
            var textInput = document.getElementById("text-input");

            var imageFiles = imageInput.files;
            var textFiles = textInput.files;

            var cardData = [];


            [...imageFiles].forEach((src, idx) => {

                var imageSrc = URL.createObjectURL(src);
                var data =  newCard({ imageUrl: imageSrc });
                cardData.push(data);

            });


            loadInputFiles(textFiles, 'text').then(textData => {

                return textData.join('.').split('.').filter(sentence => sentence !== '');

            }).then(sentences => {

                return cardData.map((card, index) => {
                    var data = { ...card, text: sentences[index] }
                    storage.add(data);
                    return data;

                });

            } ).then(cardsData => {

                storage.textConcat();
                loadCards(cardsData);

            }).catch(err=>console.error(err));

        }
    </script>


    <script>
        function setStateTextInput(ev) {
            document.getElementById("text-input").disabled = false;
        }
    </script>

    <script>
        function deleteCard(ev) {

            if (! ev.target.className.includes('card-delete')) {
                return
            }

            var card = ev.target.closest('[id^="input-card-"]');
            var cardContainer = card.closest('.card-component');
            var index = parseInt(card.id.split('-').pop());

            storage.remove(index);

        }

        function duplicateCard(ev) {

            if (! ev.target.className.includes('card-duplicate')) {
                return
            }

            var card = ev.target.closest('[id^="input-card-"]');
            var cardContainer = card.closest('.card-component');
            var index = parseInt(card.id.split('-').pop());
            console.log('-', card, index);

            storage.duplicate(index);
        }

        function setStateCard(state, card) {
            var classes = ['border', 'border-3', 'shadow', 'shadow-lg', 'border-warning', 'shadow-warning'];

            if(state) {
                card.classList.remove(...classes);
            } else {
                card.classList.add(...classes);
            }

            card.setAttribute('data-active', ! state);
        }

        function getStatusCard(card) {
            return (card.getAttribute('data-active') === "true");
        }

        function selectCard(ev) {

            if (! ev.target.className.includes('select')) {
                return
            }
            console.log(ev)

            var card = ev.target.closest('[id^="input-card-"]');
            var cardContainer = card.closest('.card-component');
            var index = parseInt(card.id.split('-').pop());

            var isActive = getStatusCard(card)
            setStateCard(isActive, card);

            var cards = document.querySelectorAll('.manwha-card');

            var c = 0;
            cards.forEach((crd, i) => {
                var counter = card.querySelector('[data-counter]');
                var status = getStatusCard(crd);
                var classes = ['bg-warning'];

                counter.innerHTML = '0';
                if(status) {
                    counter.classList.add(...classes);
                    counter.innerHTML = `${c++}`;
                    console.log(c, counter, counter.innerHTML);
                } else {
                    counter.classList.remove(...classes);
                }
            });

        }

        function updateText(target) {

            if (! target.className.includes('data-text')) {
                return
            }

            var card = target.closest('[id^="input-card-"]');
            var cardContainer = card.closest('.card-component');
            var index = parseInt(card.id.split('-').pop());

            var cards = document.querySelectorAll('.manwha-card');
            var innerValue =  target.value;

            var sentences = storage.getText().split(".").filter(sentence => sentence !== '');
            sentences[index] = innerValue;
            storage.setText(sentences.join('.'));
            var text = storage.getText().split('.').filter(sentence => sentence !== '').join('.');

            cards.forEach((c, i) => {
                var sentence = text.split('.')[i];
                c.querySelector('[data-text]').value = sentence;
            })

        }
    </script>

    <script>
        document.getElementById('listar').addEventListener('click', getData);
        document.getElementById('image-input').addEventListener('change', setStateTextInput)
        document.getElementById('grid').addEventListener('click', (ev) => {

            deleteCard(ev);
            duplicateCard(ev);
            selectCard(ev);


        })
        document.getElementById('grid').addEventListener('change', function(ev) {

            updateText(ev.target);

        })
    </script>

    <script>

    </script>
</body>
</html>