<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <header class="header " >
        <nav class="navbar bg-body-tertiary ">
            <div class="container-fluid ">
                <div class="border border-sm w-100">
                    <h2 class="my-4">
                        Manwha
                    </h2>
                </div>
            </div>
          </nav>
    </header>
    <main>
        <section class="mb-4">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header">
                        <h1 class="text-center">Importar</h1>
                    </div>
                    <div class="card-body">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <header class="pt-4">
                                                <h2 class="">Imagens</h2>
                                            </header>
                                            <hr>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="formFileMultiple" class="form-label">Escolha as imagens.</label>
                                                <input id="image-input" class="form-control" type="file" id="formFileMultiple" multiple>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="formFileMultiple" class="form-label">Escolha os textos.</label>
                                                <input disabled id="text-input" class="form-control" type="file" id="formFileMultiple" multiple>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="mb-4">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-header ">
                        <h2 class="text-center">
                            Imagens Grid
                        </h2>
                    </div>
                    <div class="card-body pt-4">
                        <h3 class="text-center mb-4">Escolhas as imagens abaixo</h3>
                        <hr>
                            <div class="container">
                                <div class="row">
                                    <div class="col-md-4"></div>
                                    <div class="col-md-4">
                                        <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                            <button  id="clean-all-selections" type="button" class="btn btn-danger btn-block py-4 rounded-0">Limpar</button>
                                            <button id="save-all" type="button" class="btn btn-primary btn-block py-4 rounded-0">Salvar</button>
                                        </div>
                                    </div>
                                    <div class="col-md-4"></div>
                                </div>
                            </div>
                        <hr>
                        <div class="container-fluid mt-4">
                            <div id="grid" class="row">
                                <!--

                                <div class="col-md-4">
                                    <div class="d-flex justify-content-center align-items-end h-100">

                                        <div id="card-0" class="card mb-3" style="max-width: 540px;">
                                            <div class="row g-0">
                                                <div class="col-md-6">
                                                    <div id="previewInputGroup" class="input-group mb-3">
                                                        <input type="file" class="form-control visually-hidden" id="inputGroupFile01" aria-describedby="inputGroupFileAddon01">
                                                        <label class="input-group-text p-0" for="inputGroupFile01">
                                                            <img data-imageSrc src="./project/Damn-Reincarnation/img/1.1/0099-3-image.png" class="img-fluid rounded-start input-image" alt="...">
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card border border-0 h-100">
                                                        <div class="card-header p-0">
                                                            <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                                                <button type="button" class="btn btn-danger btn-block py-1 rounded-0">Excluir</button>
                                                                <button type="button" class="btn btn-alert btn-primary py-1 rounded-0">Salvar</button>
                                                                <button type="button" class="btn btn-success btn-block py-1 rounded-0">+</button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                        <h5 class="card-title">Card title</h5>
                                                        <p data-text class="card-text input-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                                                        <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p>
                                                        </div>
                                                        <div class="card-footer p-0">
                                                            <div class="btn-group d-flex" role="group" aria-label="Basic example">
                                                                <button type="button" class="btn btn-primary btn-block py-4 rounded-0">Incluir</button>
                                                                <button type="button" class="btn btn-danger btn-block py-4 rounded-0">Excluir</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="position-fixed bottom-0 end-0 " style="margin-right: 2rem; margin-bottom: 2rem;">
            <button id="total"  type="button" class="btn btn-primary">0</button>
        </div>
    </main>
    <!-- Inclua a biblioteca JSZip via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="./asset/js/states/counter.js"></script>

    <script src="./asset/js/infra/zip.js"></script>
    <script src="./asset/js/view_components/card.js"></script>
    <script src="./asset/js/models/manwha.js"></script>
    <script src="./asset/js/controllers/manwha-controller.js"></script>

    <script>
        var ManwhaPage = {};
        var counter = new Counter();
    </script>

    <script>
        ManwhaPage.index = function(ev) {
            var cardsHTML = manwhaController.index({imageInput});
            var grid = document.getElementById('grid');
            var textInput = document.getElementById('text-input');
            grid.innerHTML = cardsHTML;
        }
    </script>
    <script>
        var fileData = {
            fileContents: [],
            sentences: []
        }

        ManwhaPage.listeText = function(ev) {
            var cards = document.querySelectorAll('.manwha-card');


            manwhaController.loadInputTextContent(textInput).then((data) => {
                var cardsText = document.querySelectorAll('[data-text]');

                fileData = data;
                fileData.sentences.forEach((sentence, index) => {
                    var textElement = cardsText[index];

                    if(textElement) {
                        textElement.value = '';
                        textElement.value = sentence;
                    } else {
                        //console.log(index)
                    }
                })

                return fileData.fileContents;
            })
        }
    </script>

    <script>
        ManwhaPage.deletion = function (ev) {
            var cardsComponents = document.querySelectorAll('.card-component');

            cardsComponents.forEach(cardComponent => {
                var buttonDelete = cardComponent.querySelector('.delete');

                buttonDelete.addEventListener('click', function() {
                    var card = cardComponent.querySelector('.manwha-card');
                    var status = card.getAttribute('data-active');
                    var grid = document.getElementById('grid');
                    console.log('click');

                    if (status == "false") {
                        updatedCards = manwhaController.destroy(card.id, cardsComponents);

                        grid.innerHTML = '';
                        var fragment = document.createDocumentFragment();
                        updatedCards.forEach(card => {
                            fragment.appendChild(card);
                        });

                        grid.appendChild(fragment);
                    } else {
                        alert('Tire a seleção do card.')
                    }
                })

            })
        }
    </script>

    <script>
        ManwhaPage.store = function(ev) {
            var cardElements = document.querySelectorAll('[id^="input-card-"]');
            var request = [];

            cardElements.forEach((card) => {
                var status = card.getAttribute('data-active');

                if(status) {
                    request.push({
                        order: card.id.match(/\d+/)[0],
                        imageSrc: card.querySelector('[data-imageSrc]').src,
                        text: card.querySelector('[data-text]').innerHTML,
                    });
                }
            })

            manwhaController.store(request);
        }
    </script>

    <script>

        ManwhaPage.updateCardStyle = function (card) {
            var status = card.getAttribute('data-active');
            var classes = ['border', 'border-warning', 'border-3', 'shadow', 'shadow-lg'];

            if(status == "true") {
                card.classList.remove(...classes);
            } else {
                card.classList.add(...classes);
            }
        }

        ManwhaPage.updateButtonCreateDelete = function (button, card) {
            var status = card.getAttribute('data-active');

            if (status == "true") {
                button.classList.add('btn-primary');
                button.classList.remove('btn-danger');
                button.innerHTML = '';
                button.innerHTML = 'Selecionar';
            } else {
                button.classList.remove('btn-primary');
                button.classList.add('btn-danger');
                button.innerHTML = '';
                button.innerHTML = 'Tirar Seleção';
            }
        }

        ManwhaPage.updateCards = function (cards) {
            var counter = 0;

            cards.forEach(card => {
                var status = card.getAttribute('data-active');
                var cardCounter = card.querySelector('[data-counter]');

                cardCounter.innerHTML = 0;
                card.setAttribute('data-active', "false");

                if (status == "true") {
                    counter = counter + 1;
                    console.log('counter', counter);
                    cardCounter.innerHTML = counter;
                    card.setAttribute('data-active', "true");
                }
            })
        }

        ManwhaPage.updateCardStatus = function(card) {
            var status = card.getAttribute('data-active');

            if (status == "true") {
                card.setAttribute('data-active', "false");
            } else {
                card.setAttribute('data-active', "true");
            }
        }

        ManwhaPage.updateCounter = function (card) {
            var status = card.getAttribute('data-active');

            console.log('s',counter);
            if (card == "true") {
                counter.increment();
            } else {
                counter.decrement();
            }
        }

        ManwhaPage.updateTotal = function (card) {
            var total = document.getElementById('total');
            total.innerHTML = '';
            total.innerHTML = counter.getValue();
        }

        ManwhaPage.seletion = function (ev) {
            var target = ev.target;
            var cards = document.querySelectorAll('.manwha-card');
            var Selection = {};

            Selection.check = function (e, card, cards) {
                var button = card.querySelector('.select')
                var cardCounter = card.querySelector('[data-counter]');
                ManwhaPage.updateCardStyle(card);
                ManwhaPage.updateButtonCreateDelete(button, card);
                ManwhaPage.updateCardStatus(card);
                ManwhaPage.updateCounter(card);
                ManwhaPage.updateCards(cards);
                ManwhaPage.updateTotal(cards)
            }

            cards.forEach((card) => {
                var button = card.querySelector('.select');

                button.addEventListener('click', function(ev) {
                    Selection.check(ev, card, cards);
                })
            })

        }

    </script>

    <script>
        ManwhaPage.updateImage = function(ev) {
            var target = ev.target;
            var targetParent = target.parentElement;

            if (targetParent.hasAttribute('id') && targetParent.getAttribute('id').startsWith('previewInputGroup')) {
                var inputElement = target;
                var imageElement = document.querySelector('img');
                var labelImageParentElement =  imageElement.parentElement;

                var imageElement = manwhaController.updateImage({imageElement});
                labelImageParentElement.innerHTML = '';
                labelImageParentElement.appendChild(imageElement);
            }
        }
    </script>

    <script>

        function propagateTextChanges(sentences) {
            var cardTexts = document.querySelectorAll('[data-text]');
            sentences.forEach((sentence, index) => {
                var textElement = cardTexts[index];
                if(textElement) {
                    textElement.value ='';
                    textElement.value = sentence;
                } else {
                    //console.log(index);
                }
            })
        }
        ManwhaPage.textPropagate = function(ev) {
            var textContent = ev.target.value;
            var ref = parseInt(ev.target.closest('[id^="input-card-"]').id.split('-').pop());
            fileData.sentences[ref] = textContent;
            fileData.sentences = fileData.sentences.join('.').split('.').filter(sentence => sentence !== '');

            propagateTextChanges(fileData.sentences);
        }
    </script>

    <script>
        ManwhaPage.splitCard = function(ev) {
            var cardsComponents = document.querySelectorAll('.card-component');
            var card_id = parseInt(ev.target.closest('[id^="input-card-"]').id.split('-').pop());
            var duplicated = cardsComponents[card_id].cloneNode(true);

            cardsComponents[card_id].parentNode.insertBefore(duplicated, cardsComponents[card_id].nextSibling);

            cardsComponents.forEach((cardComponent, idx) => {
                var card = cardComponent.querySelector('.manwha-card');
                card.id = `input-card-${idx}`;
            });
        }
    </script>

    <script>
        var imageInput = document.getElementById('image-input');
        imageInput.addEventListener('change', function(ev) {
            document.getElementById('text-input').disabled = !document.getElementById('text-input').disabled;

            ManwhaPage.index(ev);
            ManwhaPage.seletion(ev);
            ManwhaPage.deletion(ev);
        });

        var textInput = document.getElementById('text-input');
        textInput.addEventListener('change', function(ev) {
            ManwhaPage.listeText(ev);
        })

        var grid = document.getElementById('grid');
        grid.addEventListener('change', function (ev) {
            ManwhaPage.updateImage(ev);

            if (ev.target.hasAttribute('data-text')) {
               ManwhaPage.textPropagate(ev);
            }
        });

        grid.addEventListener('click', function(ev) {
            if (ev.target.classList.contains('split')) {
               ManwhaPage.splitCard(ev);
            }
        })

        var saveAllButton = document.getElementById('save-all');
        saveAllButton.addEventListener('click', function(ev) {
            ManwhaPage.store(ev);
        });
    </script>
</body>
</html>